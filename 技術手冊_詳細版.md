# 技術手冊（Ragic ERP 資料備份系統）- 詳細版

**版本**: v3.0
**更新日期**: 2025-10-23
**適用對象**: 系統開發者、技術維運人員

---

## 目錄

1. [系統架構](#1-系統架構)
2. [核心模組](#2-核心模組)
3. [資料流程](#3-資料流程)
4. [配置管理 (重要)](#4-配置管理-重要)
5. [環境變數 (回退方案)](#5-環境變數-回退方案)
6. [函數與類別](#6-函數與類別)
7. [部署架構](#7-部署架構)
8. [手動工具集](#8-手動工具集)
9. [錯誤處理](#9-錯誤處理)
10. [效能優化](#10-效能優化)
11. [安全機制](#11-安全機制)
12. [維護指南](#12-維護指南)

---

## 1. 系統架構

### 1.1 整體架構圖

```
┌─────────────┐
│  Ragic API  │ (資料來源)
└──────┬──────┘
       │ HTTPS + Basic Auth
       ↓
┌──────────────────────┐
│  ragic_client.py     │ (資料擷取層)
└──────┬───────────────┘
       │ List[Dict] (原始資料)
       ↓
┌──────────────────────┐
│ data_transformer.py  │ (資料轉換層)
└──────┬───────────────┘
       │ List[Dict] (轉換後資料)
       ↓
┌──────────────────────┐
│ bigquery_uploader.py │ (資料載入層)
└──────┬───────────────┘
       │ Upload Result
       ↓
┌──────────────────────┐
│ email_notifier.py    │ (通知層)
└──────────────────────┘
```

### 1.2 運作模式

系統支援兩種運作模式：
- **自動化備份 (Cloud Function)**: 由 Cloud Scheduler 定時觸發，執行增量備份。
- **手動執行 (本地/VM)**: 透過 `Manual_fetch_all_Ragic/` 下的工具集，執行手動、全量或增量備份。

---

## 2. 核心模組

| 檔案名稱 | 主要功能 |
|---|---|
| `erp_backup_main.py` | 主程式，整合所有模組，作為 Cloud Function 入口。 |
| `ragic_client.py` | 從 Ragic API 獲取資料，支援分頁和重試。 |
| `data_transformer.py` | 將資料從 Ragic 格式轉換為 BigQuery 格式，處理欄位映射和型別轉換。 |
| `bigquery_uploader.py` | 將資料上傳至 BigQuery，支援多種上傳模式 (MERGE, Staging+SP)。 |
| `email_notifier.py` | 從 Cloud Logging 獲取日誌並發送郵件通知。 |
| `config_loader.py` | **核心配置模組**。從 BigQuery 動態載入系統配置，失敗時回退至環境變數。 |
| `config_field_mapping.py` | 提供靜態 (硬編碼) 的欄位對照表。 |

---

## 3. 資料流程

1.  **載入配置**: `config_loader.py` 從 BigQuery `backup_config` 表讀取要備份的表單清單。
2.  **查詢同步點**: `bigquery_uploader.py` 查詢 BigQuery 中各表 (`sheet_code`) 的最新時間戳。
3.  **增量擷取**: `ragic_client.py` 根據時間戳，從 Ragic API 抓取變動的資料。
4.  **資料轉換**: `data_transformer.py` 使用三層欄位對照策略 (靜態、動態、自動拼音) 轉換資料。
5.  **資料上傳**: `bigquery_uploader.py` 根據資料量自動選擇最優上傳策略 (Direct MERGE 或 Staging+SP) 至 BigQuery。
6.  **結果通知**: `email_notifier.py` 發送執行結果郵件。

---

## 4. 配置管理 (重要)

系統配置**優先**從 BigQuery 動態載入，這允許在不重新部署應用的情況下修改備份目標與欄位對應。環境變數僅作為**回退方案**。

### 4.1 BigQuery 配置表示意圖

**初次設定**:
必須先在 BigQuery 中執行 `sql/setup_bigquery_config_tables.sql` 腳本來建立以下兩個表並填入預設值。

#### 1. `backup_config` 表
此表定義要備份哪些 Ragic 表單。

- **Schema**:
  - `client_id` (STRING): 客戶識別碼，用於多租戶。
  - `ragic_api_key` (STRING): Ragic API Key (Base64)。
  - `ragic_account` (STRING): Ragic 帳號。
  - `sheet_code` (STRING): 內部表單代號 (e.g., '10', '99')。
  - `sheet_id` (STRING): Ragic 實際表單路徑 (e.g., 'forms8/3')。
  - `sheet_name` (STRING): 表單中文名。
  - `backup_priority` (INTEGER): 備份優先級。
  - `enabled` (BOOLEAN): 是否啟用此表單的備份。
  - `notes` (STRING): 備註。

- **管理**:
  - **停用備份**: `UPDATE backup_config SET enabled = false WHERE sheet_code = '...'`
  - **新增備份**: `INSERT INTO backup_config (...) VALUES (...)`

#### 2. `field_mappings` 表
此表提供動態的「中英文欄位」對照規則，優先級高於程式中的硬編碼。

- **Schema**:
  - `sheet_code` (STRING): 適用的表單代號。
  - `chinese_field` (STRING): Ragic 中的中文欄位名。
  - `english_field` (STRING): 要轉換成的 BigQuery 英文欄位名。
  - `type` (STRING): 資料型別 (e.g., 'STRING', 'TIMESTAMP')。
  - `enabled` (BOOLEAN): 是否啟用此對照規則。
  - `description` (STRING): 欄位描述。

- **管理**: 當 Ragic 新增欄位時，在此表新增一筆記錄即可被系統自動識別，無需改動程式碼。

---

## 5. 環境變數 (回退方案)

僅當 `config_loader.py` 無法從 BigQuery 讀取配置時，系統才會使用以下環境變數。

| 變數名稱 | 類型 | 範例值 | 說明 |
|---|---|---|---|
| `RAGIC_API_KEY` | Base64 | `cmtrUVI5...` | Ragic API 認證金鑰 |
| `RAGIC_ACCOUNT` | String | `grefun` | Ragic 子網域名稱 |
| `GCP_PROJECT_ID` | String | `b25h01-ragic` | GCP 專案 ID |
| `BIGQUERY_DATASET`| String | `erp_backup` | BigQuery 資料集名稱 |
| `BIGQUERY_TABLE` | String | `ragic_data` | BigQuery 資料表名稱 |
| `RAGIC_SHEET_ID` | String | `forms8/3` | **單表模式下**的 Ragic 表單 ID。 |
| `RAGIC_BACKUP_SHEETS` | String | `10:forms8/5,20:forms8/4` | **多表模式**的設定，格式為 `code:id` 逗號分隔。 |
| `NOTIFICATION_EMAIL`| String | `...` | 郵件主收件人 |
| `SMTP_FROM_EMAIL` | String | `...` | 發件人 Gmail |
| `SMTP_FROM_PASSWORD`| String | `...` | Gmail 應用程式密碼 |

---

## 6. 函數與類別
(此處內容與舊版文件相似，為求簡潔省略，重點在於 `config_loader.py` 的新增)

### 6.1 config_loader.py
#### BackupConfigLoader 類別
- `load_backup_config()`: 從 BigQuery `backup_config` 表載入設定。
- `get_sheet_config()`: 獲取單一表單的設定。
- `clear_cache()`: 清除記憶體中的設定快取。

#### `load_config_with_fallback()` 函數
此為系統配置的統一入口，實現了「優先 BigQuery，失敗時回退到環境變數」的邏輯。

---

## 7. 部署架構

部署流程不變，但**前置作業**增加了執行 SQL 的步驟。

1.  **準備 GCP 環境**: 建立專案，啟用計費與必要 API (BigQuery, Cloud Functions)。
2.  **設定 BigQuery**: 在 BigQuery UI 中，執行 `sql/setup_bigquery_config_tables.sql` 腳本，建立 `backup_config` 和 `field_mappings` 表。
3.  **部署 Cloud Function**: 執行 `scripts/migrate_to_gcp_cf.sh` 腳本。此腳本會讀取環境變數 (作為後備) 並部署 Cloud Function。
4.  **設定排程**: 腳本會自動建立 Cloud Scheduler 來定時觸發 Function。

---

## 8. 手動工具集 (`Manual_fetch_all_Ragic/`)

此目錄提供一組 CLI 工具，用於在本地或 VM 執行手動的資料抓取、轉換與上傳，獨立於 Cloud Function。

### 流程
1.  **抓取資料**: `fetch_ragic_all.py`
    - 從 Ragic 抓取資料並存為本地 JSON 檔案。
    - 支援**增量** (`--mode since_local_paged`) 和**全量** (`--mode full`) 模式。
    - 依賴 `backup_config` 表來決定抓取目標。
    - **範例**: `python Manual_fetch_all_Ragic/fetch_ragic_all.py --project-id grefun-testing --since-days 7`

2.  **上傳資料**: `upload_to_bigquery.py`
    - 讀取第一步產生的 JSON 檔案。
    - 執行資料轉換與驗證。
    - 將轉換後的資料上傳至 BigQuery 目標表格。
    - **範例**: `python Manual_fetch_all_Ragic/upload_to_bigquery.py --project-id grefun-testing --input-dir Manual_fetch_all_Ragic/data/<batch_id>`

詳細用法請參考 `Manual_fetch_all_Ragic/USAGE.md`。

---

## 9. 錯誤處理
(內容無重大變更)

---

## 10. 效能優化
(內容無重大變更)

---

## 11. 安全機制
(內容無重大變更)

---

## 12. 維護指南

### 日常維護
- **修改備份目標**: 直接在 BigQuery `backup_config` 表中修改 `enabled` 旗標或新增/刪除記錄。
- **新增欄位對應**: 當 Ragic 表單新增欄位時，在 `field_mappings` 表中增加新的對照規則。

### 故障排除
- **配置未生效**: 檢查 `config_loader` 的日誌，確認是從 BigQuery 還是環境變數載入。若從 BigQuery 載入，可呼叫 `clear_cache()` 或重啟 Function 來強制刷新。
- **手動執行失敗**: 依據 `USAGE.md` 檢查 `fetch_ragic_all.py` 和 `upload_to_bigquery.py` 的參數是否正確。

---