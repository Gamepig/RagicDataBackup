## 操作手冊（Ragic ERP 資料備份系統）

本手冊面向非技術背景的使用者，協助您在 Google Cloud Platform (GCP) 上部署並管理本備份系統。

### 1. 需要準備的資訊

在開始之前，請準備好以下資訊：

- **GCP 專案 ID**: 您要在此專案中安裝備份系統。
- **Ragic API Key**: 從您的 Ragic 帳號取得 (Base64 格式)。
- **Ragic 帳號名稱**: 您 Ragic 網址的子網域 (例如 `mycompany`.ragic.com)。
- **Gmail 帳號與應用程式密碼**: 用於發送備份結果通知信。基於安全考量，需使用「應用程式密碼」，而非您的 Gmail 登入密碼。

### 2. 系統安裝與部署

安裝分為三個步驟：**設定雲端資料庫** -> **設定環境** -> **執行安裝腳本**。

#### 步驟 1: 設定雲端資料庫 (BigQuery)

這是**最重要的步驟**，它會告訴系統要備份哪些資料。

1.  登入 [GCP Console](https://console.cloud.google.com/) 並選擇您的專案。
2.  在左側導覽列找到並進入 **BigQuery**。
3.  複製 `sql/setup_bigquery_config_tables.sql` 檔案中的所有文字內容。
4.  在 BigQuery 的 **「查詢」** 編輯器中，貼上您剛剛複製的內容。
5.  點擊 **「執行」** 按鈕。

完成後，您會在左側看到 `erp_backup` 資料集，其中包含 `backup_config` 和 `field_mappings` 兩個表。這表示系統的「大腦」已經設定好了。

#### 步驟 2: 設定環境 (Cloud Shell)

1.  在 GCP Console 頁面右上角，點擊 **「啟用 Cloud Shell」** 圖示 ( выглядит как `>_` )。
2.  一個終端機視窗會在頁面下方開啟。
3.  將本專案的程式碼上傳到 Cloud Shell 環境中。
4.  在終端機中，輸入以下指令 (一行一行輸入並按 Enter)，將您準備好的資訊設定到環境中：

    ```bash
    export PROD_PROJECT_ID="您的 GCP 專案 ID"
    export RAGIC_API_KEY="您的 Ragic API Key"
    export RAGIC_ACCOUNT="您的 Ragic 帳號名稱"
    export NOTIFICATION_EMAIL="接收通知的 Email"
    export SMTP_FROM_EMAIL="您的 Gmail 帳號"
    export SMTP_FROM_PASSWORD="您的 Gmail 應用程式密碼"
    ```

#### 步驟 3: 執行安裝腳本

在同一個 Cloud Shell 終端機中，執行以下指令：

```bash
bash scripts/migrate_to_gcp_cf.sh
```

腳本會自動完成所有設定。完成後，您的備份系統就安裝完畢並已在排程中 (預設為每日執行)。

### 3. 日常管理：如何啟用或停用備份

您可以隨時決定要備份哪些 Ragic 表單，而**不需要**重新安裝或修改程式碼。

1.  進入 **BigQuery** 服務。
2.  在左側找到 `erp_backup` 資料集，點開並選取 `backup_config` 表。
3.  點擊 **「查詢」**，系統會自動產生 `SELECT * FROM ...` 語法。
4.  若要**停用**某個表單的備份 (例如「訂單管理」，其 `sheet_code` 為 `50`)，請執行以下 SQL 指令：
    ```sql
    UPDATE `您的專案ID.erp_backup.backup_config`
    SET enabled = false
    WHERE sheet_code = '50';
    ```
5.  若要重新**啟用**，將 `false` 改為 `true` 即可。

### 4. 查看備份結果

- **Email 通知**: 每次備份完成後，系統會發送一封摘要郵件到您設定的信箱。
- **BigQuery 資料表**: 您可以隨時到 BigQuery 中查詢 `ragic_data` 表，查看已備份的資料。
  ```sql
  -- 查詢各表單已備份的資料筆數
  SELECT sheet_code, COUNT(*) AS total_records
  FROM `您的專案ID.erp_backup.ragic_data`
  GROUP BY sheet_code;
  ```

### 5. 常見問題

- **沒收到郵件？**
  - 請檢查 Cloud Shell 中的環境變數 (`SMTP_...`) 是否設定正確，特別是應用程式密碼。
- **備份資料沒有更新？**
  - 系統只會備份有變動的資料。請確認 Ragic 中最近有資料更新。
  - 到 BigQuery `backup_config` 表中檢查對應的表單 `enabled` 欄位是否為 `true`。

若仍有疑問，請聯絡您的技術支援人員。