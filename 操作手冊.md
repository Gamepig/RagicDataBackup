## 操作手冊（Ragic ERP 資料備份系統）

本手冊面向非程式人員，協助您在 Google Cloud Platform（GCP）上部署並操作備份系統。

### 1. 需要準備的資訊（向客戶索取）
- GCP 專案 ID（已啟用計費），地區使用 `asia-east1`
- Ragic：`RAGIC_API_KEY`（Base64）、`RAGIC_ACCOUNT`
- Email 通知：`NOTIFICATION_EMAIL`、`SMTP_FROM_EMAIL`、`SMTP_FROM_PASSWORD`
- （可選）表單對照：`SHEET_MAP_JSON`（若與預設不同）

### 2. 一鍵部署（Cloud Functions）
1) 安裝 gcloud 並登入：
   - 下載並安裝 Google Cloud SDK
   - 終端機執行：`gcloud auth login`
2) 設定必要變數，執行遷移腳本：
   - 在終端機依序輸入（替換為客戶提供的值）：
     ```bash
     export PROD_PROJECT_ID=your-prod-project
     export RAGIC_API_KEY=***    # Base64 格式
     export RAGIC_ACCOUNT=grefun  # 或客戶實際帳號
     export NOTIFICATION_EMAIL=you@example.com
     export SMTP_FROM_EMAIL=you@example.com
     export SMTP_FROM_PASSWORD=app-password
     bash scripts/migrate_to_gcp_cf.sh
     ```
3) 完成後，畫面會顯示 Cloud Function 的 URL（CF_URL）與驗證指令。

### 3. 手動觸發一次備份（驗證）
- 瀏覽器開啟 CF_URL，或在終端機執行：
  ```bash
  curl -sS "<CF_URL>" | jq .
  ```
- 成功後會寄送一封結果郵件到 `NOTIFICATION_EMAIL`，內容含：總筆數、每表筆數、執行時間與摘要。

### 4. 設定排程（每週一 03:00）
- 遷移腳本已自動建立 Cloud Scheduler；若需調整時間，請在 GCP Console 的「Cloud Scheduler」修改 cron。

### 5. 查看上傳結果（BigQuery）
- 在 BigQuery Console 選擇專案與 Dataset `erp_backup`
- 查詢各表筆數：
  ```sql
  SELECT sheet_code, COUNT(*) AS cnt
  FROM `your-prod-project.erp_backup.ragic_data`
  GROUP BY sheet_code
  ORDER BY sheet_code;
  ```

### 6. 處理未備份資料（資料有誤）
- 在 Cloud Logging 搜尋 invalid-records（或使用郵件中的錯誤摘要）
- 取得 `sheet_code` 與 `_ragicId`，到 Ragic 後台搜尋並修正欄位值
- 下次備份會自動重新評估，若資料已正確會納入備份

### 7. 常見問題
- 沒收到郵件：
  - 檢查 `NOTIFICATION_EMAIL`、`SMTP_FROM_EMAIL`、`SMTP_FROM_PASSWORD` 是否正確
  - 檢查 Cloud Logging 是否有錯誤訊息
- BigQuery 無資料：
  - 可能本週無新資料（系統僅上傳最近一週內的新增/修改）
  - 請以兩週區間測試（上上週 + 本週），確認不重複且有資料

### 8. 回滾/重新部署
- 直接重新執行 `scripts/migrate_to_gcp_cf.sh` 可覆蓋設定
- 調整排程或環境變數後，重新部署 Cloud Function 以生效

---
若仍有疑問，請聯絡系統維運或參考《技術手冊》。


