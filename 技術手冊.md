## 技術手冊（Ragic ERP 資料備份系統）

本手冊面向技術維運人員，快速說明系統架構、核心配置、模組功能及部署要點。

### 1. 系統架構與資料流

系統配置由 BigQuery 動態驅動，整體資料流如下：

1.  **讀取配置**: `config_loader` 從 BigQuery `backup_config` 表載入需備份的表單列表。
2.  **擷取資料**: `ragic_client` 根據 BigQuery 中記錄的最後同步時間，從 Ragic API 進行增量抓取。
3.  **轉換資料**: `data_transformer` 依據 `field_mappings` 表與內建規則，將資料轉換為目標 Schema。
4.  **上傳資料**: `bigquery_uploader` 將轉換後資料以高效能模式 (Auto MERGE/Staging) 上傳至 BigQuery。
5.  **發送通知**: `email_notifier` 彙整執行結果並寄送郵件。

### 2. 核心配置 (BigQuery-First)

系統的行為主要由 BigQuery 中的兩個表控制，**環境變數僅為後備方案**。

- **`backup_config`**: 定義備份目標 (Ragic 表單、API Key、啟用狀態等)。
- **`field_mappings`**: 定義動態的「中英文欄位」對照規則。

**首次設定**: 必須先在 BigQuery 執行 `sql/setup_bigquery_config_tables.sql` 腳本來建立與初始化這兩個表。

### 3. 環境變數 (回退方案)

當 BigQuery 配置無法載入時，系統會回退至使用環境變數。以下為關鍵變數：

- `GCP_PROJECT_ID`: GCP 專案 ID。
- `RAGIC_API_KEY` / `RAGIC_ACCOUNT`: Ragic 認證資訊。
- `RAGIC_BACKUP_SHEETS`: 多表備份設定 (e.g., `10:forms8/5,20:forms8/4`)。
- `NOTIFICATION_EMAIL` / `SMTP_*`: 郵件通知設定。

### 4. 模組與主要函數

- **`config_loader.load_config_with_fallback()`**: **配置入口**。優先讀取 BigQuery，失敗時讀取環境變數。
- **`ragic_client.fetch_since_local_paged()`**: 核心抓取函數，實現「本地時間過濾」的增量邏輯。
- **`data_transformer.transform_data()`**: 核心轉換函數，整合三層欄位對照策略。
- **`bigquery_uploader.upload_data()`**: 核心上傳函數，實現 `auto` 模式切換 (Direct vs. Staging)。
- **`erp_backup_main.py`**: Cloud Function 主入口，整合所有模組。

### 5. 部署 (Cloud Functions)

1.  **前置作業**: 在 BigQuery UI 執行 `sql/setup_bigquery_config_tables.sql`。
2.  **設定環境**: 設定必要的環境變數 (主要用於回退)。
3.  **執行腳本**: 執行 `scripts/migrate_to_gcp_cf.sh` 進行一鍵部署。

腳本會自動部署 Cloud Function 並建立 Cloud Scheduler 以實現定時備份。

### 6. 手動工具集 (`Manual_fetch_all_Ragic/`)

此目錄提供獨立的 CLI 工具，用於手動執行備份流程，適合測試、資料驗證或手動補跑。

- **`fetch_ragic_all.py`**: 從 Ragic 抓取資料並存為本地 JSON。
- **`upload_to_bigquery.py`**: 將本地 JSON 檔案轉換並上傳至 BigQuery。

詳細用法請參考 `Manual_fetch_all_Ragic/USAGE.md`。

### 7. 維護要點

- **停用/啟用備份**: 直接修改 BigQuery `backup_config` 表的 `enabled` 欄位。
- **新增欄位對應**: 在 `field_mappings` 表中新增一筆記錄即可，無需重新部署。
- **故障排除**: 優先檢查 Cloud Logging 的日誌，其次確認 `backup_config` 表的設定是否正確。

---
如需更深入細節，請參考 `技術手冊_詳細版.md`。